<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Prolixia ‚Äì App</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 40px; color:#0f172a; }
    .card { max-width: 960px; padding: 28px; border: 1px solid #e5e7eb; border-radius: 16px; background:#fff; }
    .row { display:flex; gap:16px; flex-wrap: wrap; align-items:center; }
    .btn { padding: 12px 18px; border-radius: 10px; border:0; cursor:pointer; background:#0f172a; color:#fff; font-weight:800; text-decoration:none; display:inline-block; }
    .btn.secondary { background:#fff; color:#0f172a; border:2px solid #0f172a; }
    .btn.blue { background:#2563eb; }
    .muted { color:#64748b; }
    input { padding:10px; border-radius:10px; border:1px solid #e5e7eb; }
    a { color:#0f172a; text-decoration:none; }
    hr { border:none; border-top:1px solid #e5e7eb; margin: 24px 0; }
    .box { background:#f8fafc; border:1px solid #e2e8f0; padding:16px; border-radius:12px; }
    .box.warn { background:#fff7ed; border-color:#fed7aa; }
    .pill { padding:4px 10px; border-radius:999px; font-size:12px; font-weight:800; }
    .pill.high { background:#fee2e2; color:#991b1b; }
    .pill.medium { background:#ffedd5; color:#9a3412; }
  </style>
</head>
<body>
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <h1 style="margin:0;">Prolixia</h1>
      <a href="/">‚Üê Landing</a>
    </div>

    <p class="muted">Support/SLA analyse: ontdek waar tickets blijven hangen.</p>

    <!-- ================= KPI SUMMARY (NIEUW) ================= -->
    {% if metrics and metrics.sla_by_type %}
    <div class="box" style="margin-top:16px;">
      <b>üìå SLA-overzicht (samenvatting)</b>

      {% set comps = [] %}
      {% set risks = [] %}
      {% for t, v in metrics.sla_by_type.items() %}
        {% set _ = comps.append(v.compliance_pct) %}
        {% set _ = risks.append(v.monthly_risk_eur_est) %}
      {% endfor %}

      {% set avg_comp = (comps|sum / comps|length) if comps|length > 0 else 0 %}
      {% set total_risk = risks|sum %}

      <div class="row" style="margin-top:10px;">
        <div>
          <b>SLA-compliance</b><br>
          <span style="font-size:22px; font-weight:800;">
            {{ "%.1f"|format(avg_comp) }}%
          </span>
        </div>

        <div>
          <b>Maandelijks risico</b><br>
          <span style="font-size:22px; font-weight:800;">
            ‚Ç¨{{ "{:,.0f}".format(total_risk) }}
          </span>
        </div>

        <div>
          <b>Trend</b><br>
          {% set trend_sum = 0 %}
          {% for t, tr in (metrics.sla_trend_by_type or {}).items() %}
            {% set trend_sum = trend_sum + tr.compliance_delta_pp %}
          {% endfor %}

          {% if trend_sum < -1 %}
            <span style="font-size:20px;">üìâ verslechterend</span>
          {% elif trend_sum > 1 %}
            <span style="font-size:20px;">üìà verbeterend</span>
          {% else %}
            <span style="font-size:20px;">‚ûñ stabiel</span>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- ================= MINI SLA TRENDS (NIEUW) ================= -->
    {% if metrics and metrics.sla_by_type %}
    <div class="box" style="margin-top:16px;">
      <b>üìä SLA-trends per type</b>

      {% for t, v in metrics.sla_by_type.items() %}
        {% set tr = (metrics.sla_trend_by_type or {}).get(t) %}
        <div style="margin-top:12px;">
          <b>{{ t.replace("_"," ").title() }}</b>

          <div class="row" style="align-items:center; margin-top:6px;">
            <div style="width:120px; height:10px; background:#e5e7eb; border-radius:6px; overflow:hidden;">
              <div style="
                width:{{ v.compliance_pct }}%;
                height:100%;
                background:
                  {% if v.compliance_pct < 80 %}#dc2626
                  {% elif v.compliance_pct < 90 %}#f59e0b
                  {% else %}#16a34a{% endif %};
              "></div>
            </div>

            <span class="muted">
              {{ v.compliance_pct }}%
              {% if tr %}
                {% if tr.compliance_delta_pp < 0 %}
                  (‚Üì {{ tr.compliance_delta_pp }} pp)
                {% elif tr.compliance_delta_pp > 0 %}
                  (‚Üë +{{ tr.compliance_delta_pp }} pp)
                {% else %}
                  (‚Üí 0 pp)
                {% endif %}
              {% endif %}
            </span>
          </div>
        </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- ================= ACTIE VEREIST ================= -->
    {% if (not active) and metrics and metrics.upgrade_signals %}
    <div class="box warn" style="margin-top:16px;">
      <b>‚ö†Ô∏è Actie vereist: structureel SLA-risico</b>
      <div class="muted" style="margin-top:6px;">
        Op basis van de geanalyseerde supportdata zijn structurele SLA-risico‚Äôs vastgesteld.
      </div>

      <div style="margin-top:10px;">
        {% for s in metrics.upgrade_signals %}
          <div class="muted" style="margin:6px 0;">
            <span class="pill {{ s.severity }}"> {{ s.severity|upper }} </span>
            &nbsp; {{ s.message }}
          </div>
        {% endfor %}
      </div>

      <div class="row" style="margin-top:12px;">
        <a class="btn blue" href="#subscribe">Bekijk volledige trends ‚Üí</a>
      </div>
    </div>
    {% endif %}

    <hr>

    <!-- ================= DEMO ================= -->
    {% if not active %}
      <h3>Probeer de demo</h3>
      {% if not demo_used %}
        <form method="post" action="/demo">
          <button class="btn" type="submit">‚ñ∂Ô∏è Analyseer demo-data</button>
        </form>
      {% else %}
        <p class="muted">Demo is al gebruikt in deze browser.</p>
      {% endif %}

      <hr>

      <h3 id="subscribe">Start abonnement</h3>
      <p class="muted">Analyseer je eigen data en ontvang PDF-rapporten.</p>

      <div class="row">
        <form method="post" action="/subscribe/basic">
          <input type="email" name="email" required placeholder="jij@bedrijf.nl">
          <button class="btn secondary" type="submit">Basic ‚Äì ‚Ç¨19 / maand</button>
        </form>

        <form method="post" action="/subscribe/pro">
          <input type="email" name="email" required placeholder="jij@bedrijf.nl">
          <button class="btn" type="submit">Pro ‚Äì ‚Ç¨49 / maand</button>
        </form>
      </div>
    {% else %}
      <p>Welkom terug <b>{{ email }}</b> <span class="muted">({{ plan|upper }})</span></p>

      <h3>Upload je CSV</h3>
      <form id="uploadForm" class="row">
        <input type="file" name="file" accept=".csv,text/csv" required />
        <input type="number" name="rate" min="1" step="1" value="60" />
        <button class="btn" type="submit">Analyseer & genereer PDF</button>
      </form>

      <p id="msg" class="muted"></p>
    {% endif %}
  </div>

  {% if active %}
  <script>
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const res = await fetch("/upload", { method: "POST", body: fd });
      let data = {};
      try { data = await res.json(); } catch {}
      if (res.ok && data.filename) {
        window.location = "/download/" + encodeURIComponent(data.filename);
      } else {
        document.getElementById("msg").textContent = "Upload mislukt. Controleer je CSV.";
      }
    });
  </script>
  {% endif %}
</body>
</html>
