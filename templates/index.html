<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Process Detector</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 40px; }
    .card { max-width: 980px; padding: 24px; border: 1px solid #e5e7eb; border-radius: 14px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    h1 { margin: 0 0 8px; font-size: 28px; }
    p { margin: 0 0 14px; color: #374151; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    input[type="file"], input[type="email"], input[type="number"] { padding: 10px; border: 1px solid #e5e7eb; border-radius: 10px; background: #fff; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; background: #111827; color: #fff; font-weight: 700; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    .status { margin-top: 16px; padding: 12px 14px; border-radius: 12px; border: 1px solid #e5e7eb; background: #f9fafb; display: none; }
    .status.show { display: block; }
    .status.ok { border-color: #bbf7d0; background: #f0fdf4; }
    .status.err { border-color: #fecaca; background: #fef2f2; }
    .spinner { width: 16px; height: 16px; border-radius: 999px; border: 2px solid #d1d5db; border-top-color: #111827; animation: spin 0.85s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .muted { color: #6b7280; font-size: 13px; margin-top: 6px; }
    a { color: #111827; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#f3f4f6; border:1px solid #e5e7eb; font-size:12px; }
    hr { border:none;border-top:1px solid #e5e7eb;margin:18px 0; }

    .history { margin-top: 22px; }
    .history h3 { margin: 0 0 10px; }
    .history-item { border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px 14px; margin-bottom: 10px; background: #fff; }
    .history-top { display:flex; gap:10px; justify-content: space-between; flex-wrap: wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; color:#6b7280; }
  </style>
</head>
<body>
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="row" style="gap:10px;">
        <h1 style="margin:0;">Process Detector</h1>
        <a class="pill" href="/landing">Landing</a>
      </div>

      {% if active %}
        <span class="pill">âœ… Actief: {{ plan|upper }}{% if email %} â€” {{ email }}{% endif %}</span>
      {% else %}
        <span class="pill">ðŸ”’ Abonnement vereist</span>
      {% endif %}
    </div>

    <p>Upload een CSV event-log. De tool detecteert procesvertragingen en genereert automatisch een PDF-rapport met impact in uren Ã©n â‚¬.</p>

    {% if active %}
      <div class="muted">Gebruik deze maand: <b>{{ used }}</b> / <b>{{ limit }}</b> uploads</div>
    {% endif %}

    {% if not active %}
      <form method="post" action="/billing/checkout" class="row" style="margin-top:10px;">
        <input type="email" name="email" placeholder="jij@bedrijf.nl" required />
        <button type="submit" name="plan" value="basic">Basic</button>
        <button type="submit" name="plan" value="pro">Pro</button>
      </form>
      <div class="muted">Na betaling wordt je toegang geactiveerd via Stripe webhooks.</div>
      <hr>
    {% else %}
      <form method="post" action="/billing/portal" style="margin: 10px 0 14px;">
        <button type="submit">Beheer abonnement</button>
      </form>
    {% endif %}

    <form id="uploadForm">
      <div class="row">
        <input id="fileInput" type="file" name="file" accept=".csv,text/csv" required {% if not active %}disabled{% endif %} />
        <input id="rateInput" type="number" name="rate" placeholder="â‚¬ per uur (bijv. 60)" min="1" step="1" value="60" required {% if not active %}disabled{% endif %} />
        <button id="submitBtn" type="submit" {% if not active %}disabled{% endif %}>Analyseer & genereer PDF</button>
      </div>
      <div class="muted">CSV moet minimaal <code>case_id</code> en <code>timestamp</code> bevatten (en een event/stap kolom).</div>
    </form>

    <div id="statusBox" class="status">
      <div id="statusLine"></div>
      <div id="downloadLine" style="margin-top:10px; display:none;"></div>
    </div>

    {% if active and history and history|length > 0 %}
      <div class="history">
        <h3>Eerdere analyses</h3>
        {% for h in history %}
          <div class="history-item">
            <div class="history-top">
              <div><b>{{ h.date }}</b></div>
              <div>
                <a href="/download/{{ h.pdf }}">Download PDF</a>
              </div>
            </div>
            <div class="muted">
              Impact: <b>{{ "%.2f"|format(h.impact_hours) }}</b> uur
              â€¢ â‚¬<b>{{ "%.2f"|format(h.impact_eur) }}</b>
              â€¢ Rate: â‚¬{{ "%.2f"|format(h.eur_per_hour) }}/uur
            </div>
            <div class="mono">CSV: {{ h.csv_name }} â€¢ PDF: {{ h.pdf }}</div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <script>
    const form = document.getElementById("uploadForm");
    const fileInput = document.getElementById("fileInput");
    const rateInput = document.getElementById("rateInput");
    const submitBtn = document.getElementById("submitBtn");
    const statusBox = document.getElementById("statusBox");
    const statusLine = document.getElementById("statusLine");
    const downloadLine = document.getElementById("downloadLine");

    function setBusy(isBusy, message) {
      submitBtn.disabled = isBusy;
      fileInput.disabled = isBusy;
      rateInput.disabled = isBusy;

      statusBox.classList.add("show");
      statusBox.classList.remove("ok", "err");
      downloadLine.style.display = "none";
      downloadLine.innerHTML = "";

      if (isBusy) statusLine.innerHTML = `<span class="spinner"></span>${message || "Analyse bezig..."}`;
      else statusLine.innerHTML = message || "";
    }

    function setError(message) {
      statusBox.classList.add("show", "err");
      statusBox.classList.remove("ok");
      statusLine.innerHTML = message;
      downloadLine.style.display = "none";
      downloadLine.innerHTML = "";
      submitBtn.disabled = false;
      fileInput.disabled = false;
      rateInput.disabled = false;
    }

    function setSuccess(message, downloadUrl) {
      statusBox.classList.add("show", "ok");
      statusBox.classList.remove("err");
      statusLine.innerHTML = message;

      if (downloadUrl) {
        downloadLine.style.display = "block";
        downloadLine.innerHTML = `âœ… <a href="${downloadUrl}">Download opnieuw</a>`;
      }
      submitBtn.disabled = false;
      fileInput.disabled = false;
      rateInput.disabled = false;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const file = fileInput.files && fileInput.files[0];
      if (!file) return setError("Kies eerst een CSV-bestand.");
      if (!(file.name || "").toLowerCase().endsWith(".csv")) return setError("Upload een bestand met .csv.");

      const rate = Number(rateInput.value || 0);
      if (!rate || rate <= 0) return setError("Vul een geldige â‚¬ per uur in (bijv. 60).");

      setBusy(true, "CSV uploaden & analyserenâ€¦");

      const fd = new FormData();
      fd.append("file", file);
      fd.append("rate", String(rate));

      try {
        const res = await fetch("/upload", { method: "POST", body: fd });
        const ct = res.headers.get("content-type") || "";
        const payload = ct.includes("application/json") ? await res.json() : null;

        if (!res.ok) {
          const msg = payload?.detail || `Upload mislukt (HTTP ${res.status}).`;
          return setError(msg);
        }

        const filename = payload?.filename;
        if (!filename) return setError("Geen PDF-bestandsnaam ontvangen van de server.");

        const downloadUrl = `/download/${encodeURIComponent(filename)}`;
        window.location = downloadUrl;
        setSuccess("Rapport is gegenereerd. Je download start automatisch. (Pagina verversen om history te zien.)", downloadUrl);
      } catch {
        setError("Er ging iets mis tijdens upload/analyse. Probeer opnieuw.");
      }
    });
  </script>
</body>
</html>
